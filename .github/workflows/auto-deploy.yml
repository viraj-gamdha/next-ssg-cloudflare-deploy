name: Auto Deploy on Trigger

on:
  # Triggered by your Hono API
  repository_dispatch:
    types: [trigger-deploy]
  
  # Allows manual triggering from the GitHub Actions UI
  workflow_dispatch:
    inputs:
      message:
        description: 'Manual deployment message'
        required: false
        default: 'Manual deployment from GitHub Actions'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Define environment variables for the entire job
    env:
      # This logic correctly selects the message from the API trigger, manual trigger, or a default.
      DEPLOY_MESSAGE: ${{ github.event.client_payload.message || github.event.inputs.message || 'Automated deployment via API' }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      PROJECT_NAME: ${{ secrets.PROJECT_NAME }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Using version 20 as specified
          cache: 'npm'
      
      - name: ðŸ“ Log Deployment Message
        run: echo "ðŸ“ Deployment message - ${{ env.DEPLOY_MESSAGE }}"
          
      - name: ðŸ“¦ Install Dependencies
        run: npm install
      
      - name: ðŸ”¨ Build Project
        run: npm run build
      
      - name: ðŸš€ Deploy to Cloudflare Pages
        run: |
          npx wrangler pages deploy out \
            --project-name="${{ env.PROJECT_NAME }}" \
            --branch="main" \
            --commit-message="${{ env.DEPLOY_MESSAGE }}"
      
      - name: ðŸŽ‰ Final Summary
        run: |
          echo "### âœ… Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ env.PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Message:** ${{ env.DEPLOY_MESSAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY